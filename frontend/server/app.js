/**
 * @fileoverview Server running on express, serving static app and routing to public API
 */


/** Instantiate app */
const express = require('express')
const app = express()


/** Compile src with webpack */
const compiler = require('./utils/compiler')
const webpackDevMiddleware = require('webpack-dev-middleware')
const webpackHotMiddleware = require('webpack-hot-middleware')
app.use(webpackDevMiddleware(compiler))
app.use(webpackHotMiddleware(compiler))


/** Instantiate session storage */
const session = require('express-session')
app.use(session({
    secret: 'huh',
}))


/** Use json parser to parse request bodies */
app.use(express.json())


/** Link app to namespaced routes hitting api.opentestdata.org */
const apiRouter = require('./routes/api')
app.use('/api', apiRouter)


/** Define templates or assets on all other routes */
const history = require('connect-history-api-fallback')
app.use(history({
    rewrites: [
        { from: /^\/?$/, to: '/index.html'},
        { from: /\/.+?\/?/, to: '/index.html'},
        { from: /.+?\.(js|json|png|svg|gif|jpg|jpeg|ico|mp4)\/?$/, to: (context) => context.parsedUrl.pathname },
    ],
}))


/** Instantiate server for app */
app.set('port', process.env.PORT || 80)
app.listen(app.get('port'))
