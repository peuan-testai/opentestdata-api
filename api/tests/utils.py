import json
import random

from secrets import token_urlsafe
from ..db.models import User, Datum, DatumType, Test
from ..handlers.auth import login


def make_random_username():
    return f'test_user_{token_urlsafe(16)}'


def make_random_password():
    return token_urlsafe(16)


def make_random_email():
    return f'email_{token_urlsafe(16)}@test.com'


def make_random_bio():
    return f'I am a {token_urlsafe(8)} and work for {token_urlsafe(8)}'


def make_user(username=None, email=None, password=None, bio=None, is_admin=False):
    if username is None:
        username = make_random_username()
    if email is None:
        email = make_random_email()
    if password is None:
        password = make_random_password()
    if bio is None:
        bio = make_random_bio()

    u = User.create(username, email, password, bio, is_admin)
    u.jwt_token = login({
        'username': u.username,
        'password': password
    })['token']
    u.auth_headers = {'Authorization': 'Bearer %s' % u.jwt_token}
    u.original_password = password
    return u


def make_datum_dict(name=None, type=None, value=None):
    if type is None:
        type = 'STR'
    if value is None:
        value = token_urlsafe(8)
    if name is None:
        name = f'Random datum {value}'
    return dict(name=name, type=type, value=value)


def make_datum(author=None, datum_dict=None):
    if datum_dict is None:
        datum_dict = make_datum_dict()
    if author is None:
        author = make_user()
    datum = Datum.create(author=author,
                         value=datum_dict['value'],
                         name=datum_dict['name'],
                         type=DatumType(datum_dict['type']))
    # repopulate auth fields on the author object
    datum.author = author
    return datum


def make_object_datum_dict(author=None):
    key1 = token_urlsafe(8)
    key2 = token_urlsafe(8)
    key3 = token_urlsafe(8)
    child_datum_1 = make_datum(author=author)
    child_datum_2 = make_datum(author=author)
    child_datum_3 = make_datum(author=author)
    value = {}
    value[key1] = child_datum_1.id
    value[key2] = child_datum_2.id
    value[key3] = child_datum_3.id
    return dict(name=f'Random datum {token_urlsafe(8)}',
                type='OBJ',
                value=json.dumps(value))


def make_object_datum(author=None, object_datum_dict=None):
    if object_datum_dict is None:
        object_datum_dict = make_object_datum_dict()
    return make_datum(author=author, datum_dict=object_datum_dict)


def make_test_dict():
    dispositions = ['POS', 'NEG', 'EDGE', 'DESTRUCTIVE', 'NEUTRAL']
    data = [
        {
            'label': token_urlsafe(8),
            'datum_id': make_datum().id,
            'disposition': random.choice(dispositions)
        },
        {
            'label': token_urlsafe(8),
            'datum_id': make_datum().id,
            'disposition': random.choice(dispositions)
        }
    ]
    return dict(name=f'Test {token_urlsafe(8)}',
                data=data)


def make_test(author=None):
    if author is None:
        author = make_user()
    data_dict = make_test_dict()
    return Test.create(author=author, name=data_dict['name'], data=data_dict['data'])
